import logging
from pathlib import Path

import numpy as np
import pandas as pd

from ..core.dataset import (Field, DataField, IndexField, DataSetContainer, col2stat)


class NetperfData(DataSetContainer):
    fields = [
        Field("Socket Type"),
        Field("Protocol"),
        Field("Direction"),
        DataField("Elapsed Time (sec)"),
        DataField("Throughput"),
        Field("Throughput Units"),
        Field("Local Send Socket Size Requested"),
        Field("Local Send Socket Size Initial"),
        Field("Local Send Socket Size Final"),
        Field("Local Recv Socket Size Requested"),
        Field("Local Recv Socket Size Initial"),
        Field("Local Recv Socket Size Final"),
        Field("Remote Send Socket Size Requested"),
        Field("Remote Send Socket Size Initial"),
        Field("Remote Send Socket Size Final"),
        Field("Remote Recv Socket Size Requested"),
        Field("Remote Recv Socket Size Initial"),
        Field("Remote Recv Socket Size Final"),
        Field("Local Send Size"),
        Field("Local Recv Size"),
        Field("Remote Send Size"),
        Field("Remote Recv Size"),
        IndexField("Request Size Bytes"),
        IndexField("Response Size Bytes"),
        Field("Local CPU Util %"),
        Field("Local CPU User %"),
        Field("Local CPU System %"),
        Field("Local CPU I/O %"),
        Field("Local CPU IRQ %"),
        Field("Local CPU swintr %"),
        Field("Local CPU Util Method"),
        Field("Local Service Demand"),
        Field("Remote CPU Util %"),
        Field("Remote CPU User %"),
        Field("Remote CPU System %"),
        Field("Remote CPU I/O %"),
        Field("Remote CPU IRQ %"),
        Field("Remote CPU swintr %"),
        Field("Remote CPU Util Method"),
        Field("Remote Service Demand"),
        Field("Service Demand Units"),
        Field("Confidence Level Percent"),
        Field("Confidence Width Target"),
        Field("Confidence Iterations Run"),
        Field("Throughput Confidence Width (%)"),
        Field("Local CPU Confidence Width (%)"),
        Field("Remote CPU Confidence Width (%)"),
        DataField("Transaction Rate Tran/s"),
        DataField("Round Trip Latency usec/tran"),
        Field("Initial Burst Requests"),
        Field("Local Transport Retransmissions"),
        Field("Remote Transport Retransmissions"),
        Field("Transport MSS bytes"),
        Field("Local Send Throughput"),
        Field("Local Recv Throughput"),
        Field("Remote Send Throughput"),
        Field("Remote Recv Throughput"),
        Field("Local CPU Bind"),
        Field("Local CPU Count"),
        Field("Local Peak Per CPU Util %"),
        Field("Local Peak Per CPU ID"),
        Field("Local CPU Frequency MHz"),
        Field("Remote CPU Bind"),
        Field("Remote CPU Count"),
        Field("Remote Peak Per CPU Util %"),
        Field("Remote Peak Per CPU ID"),
        Field("Remote CPU Frequency MHz"),
        Field("Source Port"),
        Field("Source Address"),
        Field("Source Family"),
        Field("Destination Port"),
        Field("Destination Address"),
        Field("Destination Family"),
        Field("Local Send Calls"),
        Field("Local Recv Calls"),
        Field("Local Bytes Per Recv"),
        Field("Local Bytes Per Send"),
        Field("Local Bytes Sent"),
        Field("Local Bytes Received"),
        Field("Local Bytes Xferred"),
        Field("Local Send Offset"),
        Field("Local Recv Offset"),
        Field("Local Send Alignment"),
        Field("Local Recv Alignment"),
        Field("Local Send Width"),
        Field("Local Recv Width"),
        Field("Local Send Dirty Count"),
        Field("Local Recv Dirty Count"),
        Field("Local Recv Clean Count"),
        Field("Local NODELAY"),
        Field("Local Cork"),
        Field("Remote Send Calls"),
        Field("Remote Recv Calls"),
        Field("Remote Bytes Per Recv"),
        Field("Remote Bytes Per Send"),
        Field("Remote Bytes Sent"),
        Field("Remote Bytes Received"),
        Field("Remote Bytes Xferred"),
        Field("Remote Send Offset"),
        Field("Remote Recv Offset"),
        Field("Remote Send Alignment"),
        Field("Remote Recv Alignment"),
        Field("Remote Send Width"),
        Field("Remote Recv Width"),
        Field("Remote Send Dirty Count"),
        Field("Remote Recv Dirty Count"),
        Field("Remote Recv Clean Count"),
        Field("Remote NODELAY"),
        Field("Remote Cork"),
        Field("Local Interface Vendor"),
        Field("Local Interface Device"),
        Field("Local Interface Subvendor"),
        Field("Local Interface Subdevice"),
        Field("Local Interface Slot"),
        Field("Remote Interface Vendor"),
        Field("Remote Interface Device"),
        Field("Remote Interface Subvendor"),
        Field("Remote Interface Subdevice"),
        Field("Remote Interface Slot"),
        Field("Local Interval Usecs"),
        Field("Local Interval Burst"),
        Field("Remote Interval Usecs"),
        Field("Remote Interval Burst"),
        Field("Local OS Security Type ID"),
        Field("Local OS Security Enabled Num"),
        Field("Remote OS Security Type"),
        Field("Remote OS Security Enabled"),
        Field("Result Tag"),
        Field("Test UUID"),
        Field("Minimum Latency Microseconds"),
        Field("Maximum Latency Microseconds"),
        Field("50th Percentile Latency Microseconds"),
        Field("90th Percentile Latency Microseconds"),
        Field("99th Percentile Latency Microseconds"),
        Field("Mean Latency Microseconds"),
        Field("Stddev Latency Microseconds"),
        Field("Local Socket Priority"),
        Field("Remote Socket Priority"),
        Field("Local Socket TOS"),
        Field("Remote Socket TOS"),
        Field("Local Congestion Control Algorithm"),
        Field("Remote Congestion Control Algorithm"),
        Field("Local Fill File"),
        Field("Remote Fill File"),
        Field("Command Line"),
        Field("CHERI Netperf ABI"),
        Field("CHERI Kernel ABI")
    ]

    def raw_fields(self):
        return NetperfData.fields

    def load(self, filepath: Path):
        match = re.match("netperf-output-([a-zA-Z0-9-]+)\.csv", filepath.name)
        if not match:
            logging.warning("Malformed netperf output file name %s, " + "requires netperf-output-<UUID>", path)
            return
        dataset_id = match.group(1)
        csv_df = self._load_csv(path, skiprows=1)
        csv_df["__dataset_id"] = dataset_id
        self._internalize_csv(csv_df)

    def process(self):
        err_columns = (col2stat("errhi", self.data_columns()) + col2stat("errlo", self.data_columns()))
        err_df = pd.DataFrame(0, index=self.df.index, columns=err_columns)
        self.df = pd.concat([self.df, err_df], axis=1)
