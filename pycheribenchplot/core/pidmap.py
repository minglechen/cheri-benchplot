import json
from pathlib import Path

import pandas as pd
import numpy as np

from .dataset import DatasetID, DataField, StrField, Field
from .json import JSONDataSetContainer


class PidMapDataset(JSONDataSetContainer):
    """
    JSON output generated by the --libxo option of the ps command
    Currently we only support a subset of the output values
    """
    dataset_id = DatasetID.PIDMAP
    fields = [Field("pid", dtype=int), Field("uid", dtype=int), StrField("command")]

    def __init__(self, benchmark, dset_key):
        super().__init__(benchmark, dset_key)
        # Add a synthetic entry for unknown/unmatched PID number -1
        self.df.append({"pid": -1, "uid": -1, "command": "unknown"}, ignore_index=True)

    def raw_fields(self, include_derived=False):
        return PidMapDataset.fields

    def load(self, path: Path):
        with open(path, "r") as fd:
            raw_data = json.load(fd)
        records = raw_data["process-information"]["process"]
        df = pd.DataFrame.from_records(records)
        df["__dataset_id"] = self.benchmark.uuid
        df = df.astype(self._get_column_dtypes())
        self._internalize_json(df)
